<dom-module id="lrnapp-studio-submission-edit">
  <template>
    <style>
       :host {
        display: block;
        padding: 1rem;
      }

      .field {
        padding-top: 2em;
        padding-bottom: 2em;
      }

      .actions {
        display: flex;
        border-top: 2px solid gainsboro;
        margin-top: 1em;
      }

      .actions .spacer {
        flex: 1 1 auto;
      }

      iron-icon {
         margin-right: .4em; 
        --iron-icon-height: 2em;
        --iron-icon-width: 2em; 
      }

      #publish iron-icon {
        color: green;
      }
      
      #delete iron-icon {
        color: red;
      }

      .imagesfiled {
      }

      .imagesfiled__image {
        display: inline-flex;
        justify-content: space-around;
        min-height: 100px;
        position: relative;
      }
      .imagesfiled__image iron-image {
        --iron-image-height: 100px;
      }
      .imagesfiled__image iron-image:hover {
        /* transform: scale(1.1); */
      }
      .imagesfiled__image_delete {
        position: absolute;
        top: 0;
        right: 0;
      }

      .linksfield__item {
        display: flex;
        margin: auto;
      }

      .linksfield__info {
        flex: 1 1 auto;
      }

      .linksfield__create {
        display: flex;
        align-items: center;
      }

      .linksfield__input {
        flex: 1 1 auto;
      }

      .videosfield__item {
        position: relative;
        width: 300px;
        height: 200px;
      }

      .videosfield__item:after {
        content: '';
        display: block;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, .9);
        position: absolute;
        z-index: 1;
      }

      .videosfield__actions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%);
        z-index: 5;
        color: white;
      }
    </style>

    <!-- Update Submission Node -->
    <iron-ajax id="ajaxUpdateRequest" url="[[reqUrl]]" method="PUT" body="[[reqBody]]" params="[[reqParams]]" content-type="application/json"
      handle-as="json" on-response="_handleUpdateResponse"></iron-ajax>

    <!-- Generate Video Source Url for preview -->
    <iron-ajax id="videoGenerateSourceUrl" url="[[videoGenerateSourceUrl]]" method="POST" body="[[newvideo]]" params="[[reqParams]]" content-type="application/json"
      handle-as="json" on-response="_videofieldCreate"></iron-ajax>
    
    <template is="dom-if" if="{{submission}}">
      <paper-input label="Title" value="{{submission.attributes.title}}"></paper-input>

      <!-- Images -->
      <div class="imagesfield field">
        <label for="image-upload">Images</label>
        <template id="imagesfield_repeat" is="dom-repeat" items="{{submission.attributes.images}}" as="image">
          <div class="imagesfiled__image">
            <iron-image src="{{image.url}}" preload></iron-image>
            <paper-icon-button class="imagesfiled__image_delete" icon="delete" data-fid$="{{image.fid}}" on-click="_imageDelete"></paper-icon-button>
          </div>
        </template>
      </div>
      <vaadin-upload accept="[[fileTypes]]" target="[[uploadFilesUrl]]?token=[[csrfToken]]" method="POST" form-data-name="file-upload"
        on-upload-success="_handleImageUploadSuccess">
        <div class="drop-label">
          <iron-icon icon="description"></iron-icon>
          Upload files here:
        </div>
      </vaadin-upload>
    </template>

    <!-- Links -->
    <div id="linksfield" class="linksfield field">
      <label for="links-input">Links</label>
      <template is="dom-repeat" items="{{submission.attributes.links}}" as="link" observe="submission">
        <div class="linksfield__item">
          <div class="linksfield__info">
            <div class="linksfield__url">{{link.url}}</div>
          </div>
          <div class="linksfield__actions">
            <paper-icon-button icon="delete" class="linksfield__delete" data-index$="{{index}}" on-click="_linksfieldDelete"></paper-icon-button>
          </div>
        </div>
      </template>
      <div class="linksfield__create">
        <paper-icon-button icon="add" class="linksfield__create_button" on-click="_linksfieldCreate"></paper-icon-button>
        <paper-input id="link-input" class="linksfield__input" label="URL" value="{{newlink}}"></paper-input>
      </div>
    </div>

    <!-- Videos -->
    <div id="videosfield" class="videosfield field">
      <label for="videos-input">Links</label>
      <template is="dom-if" if="{{submission.attributes.video}}">
        <template is="dom-repeat" items="{{submission.attributes.video}}" as="video">
          <lrnapp-studio-submission-media-editoverlay on-delete="_videofieldDelete" data-index$="[[index]]">
            <iframe class="videosfield__iframe" src="{{video.video_src}}"></iframe>
          </lrnapp-studio-submission-media-editoverlay>
        </template>
      </template>
      <div class="videosfield__create">
        <paper-icon-button icon="add" class="videosfield__create_button" on-click="_videofieldCreate"></paper-icon-button>
        <paper-input id="videos-input" class="videosfield__input" label="URL" value="{{newvideo}}"></paper-input>
      </div>
    </div>

    <div class="actions">
      <paper-button id="publish" on-click="_publishClicked">
        <iron-icon icon="check"></iron-icon> Publish to Studio</paper-button>
      <paper-button id="save-draft">
        <iron-icon icon="drafts"></iron-icon> Save Draft</paper-button>
      <span class="spacer"></span>
      <paper-button id="delete">
        <iron-icon icon="delete"></iron-icon> Delete</paper-button>
    </div>
  </template>
  <script>
    Polymer({
      is: 'lrnapp-studio-submission-edit',
      properties: {
        reqUrl: {
          type: String
        },
        reqParams: {
          type: Object
        },
        reqBody: {
          type: Object
        },
        submission: {
          type: Object
        },
        uploadFilesUrl: {
          type: String
        },
        newlink: {
          type: String
        },
        newvideo: {
          type: String
        },
        videoGenerateSourceUrl: {
          type: String
        }
      },
      observers: [
        '_urlVarsChanged(submission.id, endPoint)',
        '_paramsChanged(csrfToken)',
        '_bodyChanged(title)'
      ],
      _urlVarsChanged: function (id, endPoint) {
        this.reqUrl = endPoint + '/api/submissions/' + id;
        this.uploadFilesUrl = endPoint + '/api/files';
        this.videoGenerateSourceUrl = endPoint + '/api/video/generate-source-url';
      },
      _paramsChanged: function (csrfToken) {
        var params = this.reqParams || {};
        params.token = csrfToken;
        this.reqParams = params;
      },
      _handleResponse: function (data) {
        this.submission = data.detail.response.data;
      },
      _publishClicked: function (e) {
        this.reqBody = this.submission;
        this.reqBody.state = 'submission_ready';
        this.$$('#ajaxUpdateRequest').generateRequest();
      },
      _handleUpdateResponse: function (res) {
        var root = this;
        var status = res.detail.response.status;
        if (status === 200) {
          // this will go back to the submission page.
          this.fire('routeChange', { path: root.route.prefix });
        }
      },
      _handleImageUploadSuccess: function (e) {
        var root = this;
        var response = e.detail.xhr.response;
        // normalize response string
        var response = JSON.parse(response);
        // get the newely created file
        if (response.data.file) {
          var file = response.data.file;
          // add it to the list of submission images.
          var submission = Object.assign({}, root.submission);
          submission.attributes = submission.attributes || {};
          submission.attributes.images = submission.attributes.images || [];
          // find out if the image is already referenced in the submission
          // images array and if it is replace it.
          var replacement = false;
          submission.attributes.images = submission.attributes.images.map(function (image) {
            if (image.fid === file.fid) {
              replacement = true;
              return file;
            }
            else {
              return image;
            }
          });
          // if the image was not a replacement then add it to the array
          if (!replacement) {
            submission.attributes.images.push(file);
          }
          this.set('submission', submission);
        }
      },
      _imageDelete: function (e) {
        var root = this;
        var normalizedEvent = Polymer.dom(e);
        var deleteFid = normalizedEvent.localTarget.getAttribute('data-fid');
        if (deleteFid) {
          // cast deleteFid to a number
          deleteFid = Number(deleteFid);
          var submission = Object.assign({}, root.submission);
          submission.attributes = submission.attributes || {};
          submission.attributes.images = submission.attributes.images || [];
          // find the delete image and filter it out of the images array
          submission.attributes.images = submission.attributes.images.filter(function (image) {
            return image.fid !== deleteFid;
          });
          // immutabley replace submission images with the new submission images.
          this.set('submission', submission);
        }
      },
      _linksfieldCreate: function (e) {
        var root = this;
        root.push('submission.attributes.links', { url: root.newlink });
        root.newlink = '';
      },
      _linksfieldDelete: function (e) {
        var root = this;
        var normalizedEvent = Polymer.dom(e);
        var deleteIndex = normalizedEvent.localTarget.getAttribute('data-index');
        root.splice('submission.attributes.links', deleteIndex, 1);
      },
      _videofieldCreate: function (e) {
        var root = this;
        var video_url = root.newvideo;
        var normalizedEvent = Polymer.dom(e);
        var tagname = normalizedEvent.localTarget.tagName;
        // find out if the component that called this function
        // if it's the iron-ajax then that means we have what we
        // need to add this new video to the array.
        if (tagname === 'IRON-AJAX') {
          var video_src = e.detail.response.data;
          root.push('submission.attributes.video', { video_url: root.newvideo, video_src: video_src });
          root.newvideo = '';
        }
        // if it wasn't iron ajax, then we need to go get the
        // newvideo's source url from the api
        else {
          this.$$('#videoGenerateSourceUrl').generateRequest();
        }
      },
      _videofieldDelete: function (e) {
        var root = this;
        var normalizedEvent = Polymer.dom(e);
        var deleteIndex = normalizedEvent.localTarget.getAttribute('data-index');
        root.splice('submission.attributes.video', deleteIndex, 1);
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function (obj) {
        return Object.keys(obj).map(function (key) {
          return obj[key];
        });
      },
      ready: function () {
      }
    });
  </script>
</dom-module>